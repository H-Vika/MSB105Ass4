---
title: "Assignment 4:"
subtitle:  "Eu statistikk."
author: "Magnus Eidesmo og Harald Vika"
date: last-modified
date-format: "dddd D MMM, YYYY"
lang: en-GB
format:
  html: default
  typst:
    papersize: a4
  pdf: 
    documentclass: article
    number-sections: true
    keep-tex: true
    papersize: A4
    fig-pos: "H"
abstract: ""
editor: 
  markdown: 
    wrap: sentence
echo: false
---

```{r}
#| label: setup
#| message: false
library(tidyverse)
library(readxl)
library(restatapi)
library(DescTools)
library(ggrepel)
library(flextable)
library(modelr)
library(plm)
library(broom)
library(sandwich)
```

## Toc. eurostat
```{r}
# xml skal ha mer detaljert info
# toc_xml <- get_eurostat_toc()
# tekstversjonen har trolig nok info for vårt formål
toc_txt <- get_eurostat_toc(mode = "txt")
```


## GDP Nuts 3
```{r}
gdp_tabs <- toc_txt |> 
# Regex AND external to regex
   filter(
     str_detect(
       string = title,
       # For å matche både små og store bokstaver
       pattern = '[Gg][Dd][Pp]'
       # AND vha. &
       ) &
     str_detect(
       string = title,
       # For å matche både små og store bokstaver og
       # space eller ikke før 3
       pattern = '[Nn][Uu][Tt][Ss]\\s*3'
       )
     ) |> 
  select(title, code)
```

```{r}
gdp_tabs |> 
  select(title, code) |> 
  flextable()  |> 
  width(1, width = 3.5) |> 
  width(2, width = 1.5)
```


```{r}
# description nama_10r_3gdp
dsd_gdp <- get_eurostat_dsd("nama_10r_3gdp")
```


```{r}
dsd_gdp |> 
  filter(concept %in% c('freq', 'unit')) |> 
  flextable()  |> 
  width(j = 1, width = 1) |> 
  width(j = 2, width = 2) |> 
  width(j = 3, width = 2)
```

```{r}
dsd_gdp |> 
  filter(concept %in% c('geo')) |> 
  head(n = 10) |> 
  flextable()  |> 
  width(j = 1, width = 1) |> 
  width(j = 2, width = 2) |> 
  width(j = 3, width = 2)
```

```{r}
#| eval: true
#| cache: true
# Gross domestic product (GDP) at current market prices by NUTS 3 regions 
# id: nama_10r_3gdp
# Vi velger å hente samtlige soner for så å filtrere ut de få vi ikke trenger
gdp <- get_eurostat_data(
  id = "nama_10r_3gdp",
  filters = list(
    # neste linje viser hvordan vi kunne ha hentet ut data
    # for spesifiserte land
    # geo = c("AT", "DE", "DK", "FR"),
    nuts_level = "3",
    unit = "MIO_PPS_EU27_2020"
  ),
  exact_match = FALSE,
  date_filter = 2000:2023,
  stringsAsFactors = FALSE
  ) |> 
  mutate(
    gdp_n3 = 1000000 * values
  ) |> 
  select(-c(unit, values)) |> 
  # Vil bare ha NUTS 3 nivå (5 karakterer). Vil aggregere selv til NUTS2,
  # NUTS1 og NUTSc  
  filter(str_length(geo) == 5) |> 
  as_tibble()
```


```{r}
dim(gdp)
```

```{r}
gdp
```

```{r}
gdp |> 
  filter(geo == "IE053") |> 
  print(n = 25)
```

```{r}
ie_data <- tibble(
  geo = c("IE053", "IE053", "IE053"),
  time = c("2015", "2016", "2017"),
  gdp_n3 = c(NA, NA, NA)
)
```

```{r}
gdp <- rbind(gdp, ie_data)
```

```{r}
gdp <- gdp |> 
  arrange(geo, time) |> 
  mutate(
    gdp_n3 = zoo::na.approx(gdp_n3)
  )
```

```{r}
gdp |> 
  filter(geo == "IE053") |> 
  print(n = 25)
```

# Population demo_r_pjanaggr3

## oppgave 1
Søker i toc_txt for tabeller
```{r}
pop_tabs <- toc_txt |>
  filter(
    # Matcher både population og Population
    str_detect(
      string = title,
      pattern = "[Pp][Oo][Pp][Uu][Ll][Aa][Tt][Ii][Oo][Nn]"
    ) &
    # Matcher både NUTS3 og NUTS 3
    str_detect(
      string = title,
      pattern = "[Nn][Uu][Tt][Ss]\\s*3"
    )
  ) |>
  select(title, code)


```



## oppgave 2
###(i)
```{r}
pop_tabs |>
  filter(
    str_detect(title, regex("population", ignore_case = TRUE)) &
    str_detect(title, regex("NUTS\\s*3", ignore_case = TRUE))
  )

```

```{r}
pop_tabs |>
  filter(
    str_detect(
      title,
      fixed("Average annual population to calculate regional GDP data (thousand persons) by NUTS 3 region")
    )
  ) |>
  select(code)
```
Finner at koden er demo_r_pjanaggr3 for tabellen med forklarende tekst «Average annual population to calculate regional GDP data (thousand persons) by NUTS 3 regions»

###(ii)
Last ned Data Structure Definition (DSD) for denne tabellen.
```{r}
dsd_pop <- get_eurostat_dsd("demo_r_pjanaggr3")
```

### (iii) (iv) og (v)
Tre av oppgavene i en, laster ned dataen og gi den navnet pop, plukker ut årene fra 2000 til 2023 og den totale befolkningen, begrenser datasettet til NUTS3 regioner og konverterer settet til en tibble.
```{r}
#| eval: true
#| cache: true
pop <- get_eurostat_data(
 id = "nama_10r_3popgdp",
 filters = list(
 nuts_level = "3",
 unit = "THS"
 ),
 exact_match = FALSE,
 date_filter = 2000:2023,
 stringsAsFactors = FALSE
 ) |>
 mutate(
 pop_n3 = values * 1000
 ) |> 
  select(-c(unit, values)) |>
 filter(str_length(geo) == 5) |> 
 as_tibble()
```

```{r}
dim(pop)
```

## Oppgave 3
Slå sammen GDP-data (gdp) og befolkingsdata (pop)
```{r}
gdp_pop <- gdp |>
  left_join(pop, by = c("geo", "time"))
```

Kontrollerer:

```{r}
dim(gdp_pop)
head(gdp_pop)
```

Gjør følgende tilpasning av gdp_pop:
```{r}
eu_data <- gdp_pop %>%
  # Trenger ikke ZZ sonene som er en slag oppsamlingssone
  # for ikke fordelte verdier
  filter(!str_sub(geo, 3, 4) == "ZZ") |> 
  # Drop the EFTA countries Switzerland and Norway
  filter(!str_sub(geo, 1, 2) %in% c("CH", "NO")) |> 
  # Drop the EU countries Netherlands and Portugal
  filter(!str_sub(geo, 1, 2) %in% c("NL", "PT")) |> 
  # Drop candidate country Monte Negro because of data
  filter(!str_sub(geo, 1, 2) %in% c("ME")) |> 
  # Drop a region of France in the Indian Ocean (Outre Mer); Mayotte
  # because of missing data
  filter(!geo == "FRY50") |> 
  # note that a few countries will have missing data for
  # some years at the start of the period
  filter(time > 1999 & time < 2023)
```

Regner ut gdp per capita og gir den et nytt navn:
```{r}
eu_data <- eu_data |>
  mutate(
  gdp_pc_n3 = gdp_n3 / pop_n3
)
```

Kontrollerer:
```{r}
dim(eu_data)
```
Sjekker om vi mangler data for enkelte år for noen soner:

```{r}
dim(
  eu_data |>
    filter(is.na(gdp_pc_n3))
)
```
Var ikke noe mer NA-verdier igjen i gdp_pc_n3
Kvitter oss med andre objekter for å rydde litt ettersom vi bare skal bruke eu_data videre:
```{r}
# don't run if you don't mean it.
rm(list = setdiff(ls(), c("eu_data")))
```


## Oppgave 4
Endrer ny navn på geo til n3 og legger til variablene n2, n1 og nc fra variabelen n3.
```{r}
eu_data <- eu_data |>
  rename(n3 = geo) |>
  mutate(
    n2 = str_sub(n3, 1, 4),
    n1 = str_sub(n3, 1, 3),
    nc = str_sub(n3, 1, 2)
  )

```

## Oppgave 5
Undersøk om vi har noen NUTS 3 soner med pop_n3 lik 0. Hvis det er noen så endre disse til NA.
Undersøker: 
```{r}
eu_data |>
  filter(pop_n3 == 0)
```
Fant ingen rader med 0 og vi går videre, trenger ikke å endre noe til NA.

## Oppgave 6
Sjekker hvor mange NUTS3 soner vi har i hvert land, tar en strukturkontroll:
```{r}
eu_data |>
  select(nc, n3) |> # Henter ut de variablene vi trenger
  distinct() |> # Fjerner duplikater 
  group_by(nc) |> # Grupperer per land
  summarise(
    num_nuts3 = n(),
    .groups = "drop"
  ) |>
  arrange(desc(num_nuts3)) # Gir mest informative oversikt, legger det største landet øverst
```

## Oppgave 7
Sjekker summary for gdp_pc_n3 for å se om hva som er har den største og minste verdien og om det er noen NA:
```{r}
summary(eu_data$gdp_pc_n3)
```

Minste verdien er 2 214, mens max er på 180 416. Får ingen NA.

## Oppgave 8 
Bruk case_when() for å legge til variabelen nc_name før vi går videre. Østerrike for AT, Belgia for BE etc..
```{r}
eu_data <- eu_data |>
  mutate(
    nc_name = case_when(
      nc == "AL" ~ "Albania",
      nc == "AT" ~ "Østerrike",
      nc == "BE" ~ "Belgia",
      nc == "BG" ~ "Bulgaria",
      nc == "CY" ~ "Kypros",
      nc == "CZ" ~ "Tjekkia",
      nc == "DE" ~ "Tyskland",
      nc == "DK" ~ "Danmark",
      nc == "EE" ~ "Estland",
      nc == "EL" ~ "Hellas",
      nc == "ES" ~ "Spania",
      nc == "FI" ~ "Finland",
      nc == "FR" ~ "Frankrike",
      nc == "HR" ~ "Kroatia",
      nc == "HU" ~ "Ungarn",
      nc == "IE" ~ "Irland",
      nc == "IT" ~ "Italia",
      nc == "LT" ~ "Litauen",
      nc == "LU" ~ "Luxemburg",
      nc == "LV" ~ "Latvia",
      nc == "MK" ~ "Nord-Makedonia",
      nc == "MT" ~ "Malta",
      nc == "PL" ~ "Polen",
      nc == "RO" ~ "Romania",
      nc == "RS" ~ "Serbia",
      nc == "SE" ~ "Sverige",
      nc == "SI" ~ "Slovenia",
      nc == "SK" ~ "Slovakia",
      nc == "TR" ~ "Tyrkia",
      TRUE ~ NA_character_
    )
  )

```
Kontrollerer:
```{r}
eu_data |> 
  select(nc_name, nc) |> 
  distinct() |> 
  print(n = 30)
```

# Beregning av Gini på NUTS2, NUTS1 og NUTSc nivå
Vi skal nå beregne Gini for hvert år på NUTS2, NUTS1, NUTSc og EU nivå. Vi vil beregne Gini utfra gdp_pc_n3 og pop_n3 i NUTS3 for alle aggregeringsnivåene.
Gini-koeffisient er tradisjonelt et mål på inntektsforskjeller. Her benytter vi målet for å undersøke hvor jevnt verdiskapningen er fordelt mellom regioner. En Gini-koeffisient nær null vil altså her bety at verdiskapingen er jevnt fordelt mellom regionene i et land. En Gini-koeffisient nær 1 vil det derimot bety at det meste av verdiskapingen i et land er sentralisert til en spesifikk NUTS3 region.

## Gini- koeffisient for NUTS2
## Oppgave 9
Beregner Gini-koeffisienter på NUTS2 nivå:

```{r}
gini_n2 <- eu_data |>
  group_by(n2, time, n1, nc, nc_name) |> 
  summarise(
    gini_n2 = DescTools::Gini(gdp_pc_n3, weights = pop_n3, na.rm = TRUE),
    pop_n2 = sum(pop_n3),
    gdp_n2 = sum(gdp_n3),
    gdp_pc_n2 =  gdp_n2 / pop_n2,
    num_reg_n2 = n(),
    .groups = "drop"
  ) 
```
Kontrollerer:

```{r}
summary(
  gini_n2 |>
    select(gini_n2, num_reg_n2, pop_n2, gdp_n2, gdp_pc_n2)
)
```
Får de samme tallene som kontrollen i oppgaven. Vi ser at vi har et spenn i Gini-koeffisienten på NUTS2 nivå fra 0.0004 til 0.4779. Vi har også 856 NAs. Vi ser også at antall NUTS3 i NUTS2 regioner spenner fra 1 til 23.

## Oppgave 10
Finner observasjoner med Gini < 0.001
```{r}
gini_n2 |>
  filter(gini_n2 < 0.001)
```
Får opp 4 obervasjoner
Se så på kjennetegnet ved disse regionene:
```{r}
gini_n2 |>
  filter(gini_n2 < 0.001) |>
  select(
    nc_name,
    n2,
    time,
    gini_n2,
    num_reg_n2,
    pop_n2,
    gdp_pc_n2
  ) |>
  arrange(num_reg_n2)

```

Det som blir observert her er at de fleste har få NUTS3-regioner i sine NUTS2, noe som gjør at alle NUTS3 regionene er omtrent lik gdp_pc_n3 eller om det bare er en region. Derfor får disse observasjonene en ekstremt lav Gini.

## Oppgave 11
Beregn Gini-koeffsienter på NUTS1-nivå, der gdp_pc_n2 eller pop_n2 ikke skal brukes som grunnlag:
```{r}
gini_n1 <- eu_data |>
  group_by(n1, time, nc, nc_name) |>
  summarise(
    gini_n1 = DescTools::Gini(
      gdp_pc_n3,
      weights = pop_n3,
      na.rm = TRUE
    ),
    pop_n1 = sum(pop_n3),
    gdp_n1 = sum(gdp_n3),
    gdp_pc_n1 = gdp_n1 / pop_n1,
    num_reg_n1 = n(),
    .groups = "drop"
  )

```
Kontrollerer:
```{r}
gini_n1 |>
  select(gini_n1, num_reg_n1, gdp_n1, pop_n1, gdp_pc_n1) |>
  summary() |>
  print(width = 80)

```
Får de samme tallene som oppgaven. Vi ser at vi har et spenn i Gini-koeffisienten på NUTS1 nivå fra 0.016 til 0.429. Antall NAs er nå 177. Vi ser at antall NUTS3 i NUTS1 regioner spenner helt fra 1 til 96.

## Oppgave 12
Beregn Gini-koeffisienter på nasjonsnivå
Måler hvor jevnt verdiskapningen er fordelt mellom regioner innen samme land:
```{r}
gini_nc <- eu_data |>
  group_by(nc, time, nc_name) |>
  summarise(
    gini_nc = DescTools::Gini(
      gdp_pc_n3,
      weights = pop_n3,
      na.rm = TRUE
    ),
    pop_nc = sum(pop_n3),
    gdp_nc = sum(gdp_n3),
    gdp_pc_nc = gdp_nc / pop_nc,
    num_reg_nc = n(),
    .groups = "drop"
  )

```

Kontrollerer 
```{r}
gini_nc |> 
  select(gini_nc, num_reg_nc, gdp_nc, pop_nc, gdp_pc_nc) |> 
  summary() |> 
  print(width = 80)
```
Får samme som oppgaven. På landsnivå varierer Gini fra 0,1111 til 0,3991. Antall NUTS3 regioner per land varierer fra 1 til 400.

# "Nestete" datastrukturer
Vi vil nå «neste» de ulike gini_NUTS* datasettene og sette dem sammen til et nestet datasett eu_data_nestet som innholder alle dataene ovenfor i en fint ordnet struktur.

## Oppgave 13
"neste" dataene på NUTS3 nivå
```{r}
gini_n3_nest <- eu_data |> 
  group_by(nc_name, nc) |> 
  nest(.key = "NUTS3_data") |> 
  ungroup()
```

```{r}
gini_n3_nest
```


## Oppgave 14
«Nest» dataene på NUTS2 nivå. Legg resultatet gini_NUTS2_nest. Bruk .key = "NUTS2_data".
```{r}
gini_NUTS2_nest <- gini_n2 |>
  group_by(nc_name, nc)|>
 nest(.key = "NUTS2_data")
```

## Oppgave 15
«Nest» dataene på NUTS1 nivå. Legg resultatet gini_NUTS1_nest.
```{r}
gini_NUTS1_nest <- gini_n1 |>
  group_by(nc_name, nc) |>
  nest(.key = "NUTS1_data") |>
  ungroup()
```

## Oppgave 16 
«Nest» dataene på nasjonsnivå. Legg resultatet i gini_NUTSc_nest.
```{r}
gini_NUTSc_nest <- gini_nc |>
  group_by(nc_name, nc) |>
  nest(.key = "NUTSc_data") |>
  ungroup()
```

## Oppgave 17
«Nest» dataene på EU nivå, dvs. Gini for samtlige NUTS3 regioner hvert år. Legger resultatet i gini_NUTSeu_nest. _nest er her litt misvisende siden vi ikke gjør noen nesting.

```{r}
gini_NUTSeu_nest <- eu_data |>
  group_by(time) |> 
  summarise(
    gini_eu = DescTools::Gini(gdp_pc_n3, weights = pop_n3, na.rm = TRUE),
    num_reg_eu = n(),
    .groups = "drop"
  ) 
```

## Oppgave 18
Vis utviklingen i Gini-koeffisienten for NUTS3 regioner i EU vha. et linjeplot.

```{r}
gini_NUTSeu_nest |>
  ggplot(aes(x = as.integer(time), y = gini_eu)) +
  geom_line(linewidth = 1) +
  geom_point(size = 1) +
  labs(
    title = "Utviklingen i Gini-koeffisienten for NUTS3-regioner i EU",
    x = "Year",
    y = "gini_eu"
  ) +
  theme_minimal()
```

## Oppgave 19
«The EU’s Structural Funds and Cohesion Fund direct funding to NUTS level 2 regions based on their GDP (PPS) per capita in comparison to the EU average: less developed regions (less than 75%), transition regions (between 75% and 90% and more developed regions (over 90%). For the period 2014–20, EUR 351 billion will be invested in the EU’s regions with most being directed to the less developed regions.»

Basert på plottet fra foregående oppgave diskuter (veldig!) kort om tiltaket ser ut til å virke:
Plottet gir støtte til at regional ulikhet har avtatt over tid i EU, noe som er forenlig med at kohesjonspolitikken kan ha hatt effekt, men analysen kan ikke fastslå årsakssammenheng.


## Oppgave 20
Ta gini_n3_nestsom utgangspunkt og bruk left_join() til å legge til datasettene gini_NUTS2_nest, gini_NUTS1_nest og gini_NUTSc_nest.

```{r}
eu_data_nested <- gini_n3_nest |>
  left_join(gini_NUTS2_nest, by = c("nc_name", "nc")) |>
  left_join(gini_NUTS1_nest, by = c("nc_name", "nc")) |>
  left_join(gini_NUTSc_nest, by = c("nc_name", "nc"))

```

slette alle objekter utenom eu_data og eu_data_nested.
```{r}
# don't run if you don't mean it.
rm(list = setdiff(ls(), c("eu_data", "eu_data_nested")))
```


#Plots som viser utvikling
## Oppgave 21
Lag et linjeplot i ggplot som viser utviklingen i Gini-koeffisient på nasjonsnivå for de 29 landene vi har med.

```{r}
gini_nc <- eu_data_nested |>
  unnest(NUTSc_data)

```

Får plotten: 
```{r}
#| label: fig-ginialle
#| fig-cap: "Utviklingen over tid for Gini-koeffisienten for de 29 landene"
gini_nc |>
  ggplot(aes(
    x = as.integer(time),
    y = gini_nc,
    group = nc_name,
    colour = nc_name
  )) +
  geom_line(linewidth = 0.7) +
  labs(
    title = "Utviklingen i Gini-koeffisienten på nasjonsnivå",
    x = "time",
    y = "Gini_nc"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    legend.title = element_blank()
  )

```

## Oppgave 22
Lager en sortert tabell for Gini i år 2022 som gjør det litt lettere å se hvilken linje som hører til hvilket land.

```{r}
gini_2022 <- gini_nc |>
  filter(time == 2022) |>
  arrange(desc(gini_nc)) |>
  select(nc_name, gini_nc)

# Skriv ut tabellen
gini_2022 |>
  flextable() |>
  set_header_labels(
    nc_name = "Land",
    gini_nc = "Gini-koeffisient"
  ) |>
  autofit()

```

## Oppgave 23

```{r}
gini_long <- eu_data_nested |>
  unnest(NUTSc_data) |>
  mutate(year = as.integer(time)) |>
  arrange(nc_name, year) |>
  # Fjern NA og NaN (NaN oppstår ofte når num_reg_nc == 1)
  filter(!is.na(gini_nc) & !is.nan(gini_nc))

```

```{r}
gini_change <- gini_long |>
  group_by(nc_name) |>
  summarise(
    first_year = first(year),
    gini_first = first(gini_nc),

    has_2022 = any(year == 2022),
    comp_year = if_else(has_2022, 2022L, last(year)),
    gini_comp = if_else(has_2022, gini_nc[year == 2022][1], last(gini_nc)),

    .groups = "drop"
  ) |>
  mutate(
    gruppe = if_else(
      gini_comp < gini_first,
      "Lavere regional ulikhet (2022 eller siste år)",
      "Høyere regional ulikhet (2022 eller siste år)"
    )
  )

```

```{r}
gini_long2 <- gini_long |>
  left_join(gini_change |> select(nc_name, gruppe), by = "nc_name")

```

```{r}
#| label: fig-Lavgini
#| fig-cap: "Land med lavere regional ulikhet i 2022 enn første år vi har data for."
gini_long2 |>
  filter(gruppe == "Lavere regional ulikhet (2022 eller siste år)") |>
  ggplot(aes(x = year, y = gini_nc, colour = nc_name, group = nc_name)) +
  geom_line(linewidth = 1) +
  labs(
    title = "Land med lavere regional ulikhet (2022 hvis mulig, ellers siste år)",
    x = "År", y = "Gini-koeffisient", colour = "Land"
  ) +
  theme_minimal()

```

```{r}
#| label: fig-Lavgini
#| fig-cap: "Land med høyere regional ulikhet i 2022 enn første år vi har data for."
gini_long2 |>
  filter(gruppe == "Høyere regional ulikhet (2022 eller siste år)") |>
  ggplot(aes(x = year, y = gini_nc, colour = nc_name, group = nc_name)) +
  geom_line(linewidth = 1) +
  labs(
    title = "Land med høyere regional ulikhet (2022 hvis mulig, ellers siste år)",
    x = "År", y = "Gini-koeffisient", colour = "Land"
  ) +
  theme_minimal()
```

## Oppgave 24
Vis vha. et linjeplot utviklingen i gini-koeffisient for NUTS2 regionene i Irland.

```{r}
ie_nuts2 <- eu_data_nested |>
  unnest(NUTS2_data) |>
  filter(nc_name == "Irland") |>
  filter(!is.na(gini_n2))
```

```{r}
ie_nuts2 |>
  ggplot(aes(
    x = as.numeric(time),
    y = gini_n2,
    group = n2,
    colour = n2
  )) +
  geom_line(linewidth = 1) +
  labs(
    title = "Utviklingen i Gini-koeffisienten for NUTS2-regionene i Irland",
    x = "År",
    y = "Gini-koeffisient",
    colour = "NUTS2"
  ) +
  theme_minimal()
```

# Hvordan er verdiskapningen fordelt mellom regionene i ulike land?
Spania hadde i år 2022 en Gini-koeffisient lik 0,134 som skulle tilsi en nokså jevn fordeling av økonomisk aktivitet mellom regionene.

## Oppgave 25
Lag et line-plot som viser utviklingen i Gini-koeffisientene for NUTS2 regionene i Spania.
```{r}
es_nuts2 <- eu_data_nested |>
  unnest(NUTS2_data) |>
  filter(nc_name == "Spania") |>
  filter(!is.na(gini_n2))
```
Kontrollerer regionene:
```{r}
es_nuts2 |>
  select(n2) |>
  distinct() |>
  arrange(n2)
```
Lager så linjeplottet:
```{r}
es_nuts2 |>
  ggplot(aes(
    x = as.numeric(time),
    y = gini_n2,
    group = n2,
    colour = n2
  )) +
  geom_line(linewidth = 0.9) +
  labs(
    title = "Utviklingen i Gini-koeffisienten for NUTS2-regionene i Spania",
    x = "År",
    y = "Gini-koeffisient",
    colour = "NUTS2"
  ) +
  theme_minimal()
```

#### Oppgave 26
Lag et line-plot som viser utviklingen i Gini-koeffisientene for NUTS1 regionene i Spania.



```{r}
eu_data_nested |>
  unnest(NUTS1_data) |>
  filter(nc_name == "Spania") |>
  ggplot(aes(
    x = as.integer(time),
    y = gini_n1,
    group = n1,
    colour = n1
  )) +
  geom_line(linewidth = 1) +
  labs(
    title = "Utviklingen i Gini-koeffisienten for NUTS1-regionene i Spania",
    x = "År",
    y = "Gini-koeffisient",
    colour = "NUTS1"
  ) +
  theme_minimal()

```

### Tyskland
#### Oppgave 27
Lag et line-plot som viser utviklingen i Gini-koeffisient for NUTS2 regionene i Tyskland.
Dropp gjerne farger. Det er så mange regioner at de er vanskelig å skille.


```{r}
eu_data_nested |>
  unnest(NUTS2_data) |>
  filter(nc_name == "Tyskland") |>
  ggplot(aes(
    x = as.integer(time),
    y = gini_n2,
    group = n2
  )) +
  geom_line(alpha = 1) +
  labs(
    title = "Utviklingen i Gini-koeffisienten for NUTS2-regionene i Tyskland",
    x = "År",
    y = "Gini-koeffisient"
  ) +
  theme_minimal()

```
Vi ser at Gini-koeffisientene spenner fra ca. 0.03 til over 0.45. Det ser altså ut til å være store forskjeller mellom NUTS2 regionene i Tyskland. Noen NUTS2 soner ser ut til å være relativt ensartet mhp. verdiskapning, mens andre er preget av store forskjeller mellom NUTS3 regionene. Hvor i landet er de plassert de regionene som har de største regionale forskjellene?
Figuren viser at Gini-koeffisientene for NUTS2-regionene i Tyskland varierer fra om lag 0,03 til over 0,45. Dette peker på betydelige forskjeller i graden av intern regional ulikhet. Regioner med lave Gini-verdier fremstår som relativt homogene når det gjelder verdiskaping mellom NUTS3-områder, mens regioner med høye Gini-verdier er kjennetegnet av store interne variasjoner. De mest markante regionale ulikhetene finnes i hovedsak i og rundt de største økonomiske sentrene og storbyregionene, særlig i de vestlige og sørlige delene av landet, hvor sterke kjerneområder sameksisterer med mindre utviklede omkringliggende regioner.


#### Oppgave 28
Er det samme er tilfelle når vi ser på de større regionene i Tyskland (NUTS1)?


```{r}
eu_data_nested |>
  unnest(NUTS1_data) |>
  filter(nc_name == "Tyskland") |>
  ggplot(aes(
    x = as.integer(time),
    y = gini_n1,
    group = n1,
    color = n1
  )) +
  geom_line(linewidth = 1) +
  labs(
    title = "Utviklingen i Gini-koeffisienten for NUTS1-regionene i Tyskland",
    x = "År",
    y = "Gini-koeffisient"
  ) +
  theme_minimal()

```
```{r}
eu_data_nested |>
 unnest(NUTS1_data) |>
 filter(nc_name == "Tyskland") |>
 filter(time == "2022") |>
 select(n1, gini_n1, num_reg_n1) |>
 arrange(desc(gini_n1)) |>
 flextable() |>
 line_spacing(space = 0.3) |>
 colformat_double(j = 2, digits = 4)

```

# Frankrike

## Oppgave 29

```{r}
eu_data_nested |>
  unnest(NUTS1_data) |>
  filter(nc_name == "Frankrike") |>
  ggplot(aes(
    x = as.integer(time),
    y = gini_n1,
    group = n1,
    color = n1
  )) +
  geom_line(linewidth = 1) +
  labs(
    title = "Utviklingen i Gini-koeffisienten for NUTS1-regionene i Frankrike",
    x = "År",
    y = "Gini-koeffisient"
  ) +
  theme_minimal()

```

## Oppgave 30
Lag en tabell som viser de 6 NUTS1 sonene i Frankrike som hadde høyest Gini-koeffisient i 2022.
```{r}
fr_nuts1_2022 <- eu_data_nested |>
  unnest(NUTS1_data) |>
  filter(nc_name == "Frankrike") |>
  filter(time == "2022") |>
  filter(!is.na(gini_n1))
```

```{r}
top6_fr_nuts1 <- fr_nuts1_2022 |>
  select(n1, gini_n1, num_reg_n1) |>
  arrange(desc(gini_n1)) |>
  slice_head(n = 6)
```

```{r}
top6_fr_nuts1 |>
  mutate(gini_n1 = round(gini_n1, 4))
```
Ut ifra tabellen ser man at FR1 er den sonen i Frankrike som har høyest Gini-koeffisient i 2022. Dette er en sone som ligger rundt Paris, og dermed skiller seg ut ifra de andre regionene i landet. Ut ifra plottet kan vi se forskjellene mellom FR1 og resten av regionene og den reflekterer store forskjeller i verdiskapninger mellom NUTS3-regionene i og rundt hovedstaden.

## Oppgave 31 
Vi ser at for Frankrike er det en region som har klart større forskjeller mht. vekst (verdiskapning) enn de andre. Sjekk NUTS3 regionenen i denne regionen nærmere vha. linjeplot og lag en tabell som viser gdp_pc_n3 for de seks sonene.

Sjekke inn på NUTS3 regionene innen FR1:
```{r}
fr1_nuts3 <- eu_data |>
  filter(n1 == "FR1") |>
  filter(!is.na(gdp_pc_n3))
```

```{r}
fr1_nuts3 |>
  ggplot(aes(
    x = as.numeric(time),
    y = gdp_pc_n3,
    group = n3
  )) +
  geom_line(alpha = 0.7) +
  labs(
    title = "Utviklingen i BNP per capita for NUTS3-regionene i Île-de-France (FR1)",
    x = "År",
    y = "BNP per capita (PPS)"
  ) +
  theme_minimal()
```
```{r}
fr1_top6_nuts3 <- fr1_nuts3 |>
  filter(time == "2022") |>
  arrange(desc(gdp_pc_n3)) |>
  slice_head(n = 6) |>
  select(n3, gdp_pc_n3)
```

FÅr tabellen:
```{r}
fr1_top6_nuts3 |>
  mutate(gdp_pc_n3 = round(gdp_pc_n3))
```
Linjeplottet for NUTS3-regionene i FR1 viser svært store forskjeller i BNP per capita mellom regionene. Noen få sentrale regioner, særlig rundt Paris, har et betydelig høyere nivå enn resten. Tabellen bekrefter dette ved at de seks regionene med høyest BNP per capita ligger markant over øvrige regioner. Dette indikerer sterk geografisk konsentrasjon av økonomisk aktivitet og forklarer den høye Gini-koeffisienten for FR1.

## Oppgave 32
Kan vi utfra foregåenede plot og tabell si noe om årsaken til at FR1 har så høy Gini-koeffisient?
Ja det kan vi. I plotten og tabellen kan vi se at det er store forskjeller i BNP per capita mellom NUTS3-regionene i FR1. Noen få regioner, særlig rundt Paris, har et svært høyt nivå av verdiskaping, mens øvrige regioner ligger betydelig lavere. Dette indikerer en sterk geografisk konsentrasjon av økonomisk aktivitet i hovedstadsområdet, noe som forklarer den høye Gini-koeffisienten for FR1.

# Enkle modeller

Vil vi undersøke om det er noen sammenheng mellom GDP og Gini-koeffisienten bør vi se på endringen i de to variablene.

#«Data Science» modeller
## Oppgave 33 
Lag datasett for endringer i gdp_per_capita og gini_nuts2. 

```{r}
n3_data <- eu_data_nested |> 
  unnest(NUTS3_data) |> 
  select(nc_name, n2, n3, time, gdp_pc_n3)
```

```{r}
n2_data <- eu_data_nested |> 
  unnest(NUTS2_data) |> 
  select(nc_name, n2, time, gini_n2)
```

```{r}
NUTS2_diff <- n3_data |> 
  left_join(n2_data, by = join_by(nc_name, n2, time)) |> 
  mutate(
    diff_gdp_per_capita = c(NA, 100 * diff(gdp_pc_n3)),
    diff_gini_nuts2 = c(NA, 100 * diff(gini_n2))
  ) %>%
  filter(complete.cases(.)) |> 
  group_by(nc_name, n2) |> 
  nest(.key = "NUTS2_diff")
```

```{r}
unnest(NUTS2_diff, NUTS2_diff) |> 
  ungroup() |> 
  filter(!is.nan(gini_n2)) |> 
  select(n2) |> 
  distinct() |> 
  nrow()
```
av disse har vi kunnet beregne Gini-koeffisient for. Vi har altså 38 NUTS2 soner som bare inneholder én NUTS3 sone.

## Oppgave 34
Bruk modellen diff_gini_nuts2 ~ diff_gdp_per_capita på hver av de 256 (218) NUTS2 regionene vha. en anonym funksjon som «mappes» (vha. map()) på «list-column» NUTS2_diff. Legg resultatet i en variabel modell.
```{r}
NUTS2_diff <- NUTS2_diff  |> 
  group_by(nc_name, n2) |> 
  mutate(
    modell = map(
      .x = NUTS2_diff,
      .f = function(a_df) lm('diff_gini_nuts2 ~ diff_gdp_per_capita', data = a_df)
    )
  )
```

## Oppgave 35
Hent ut koeffisientene fra de 256 (218) modellene og legg resultatet i variabelen mod_coeff. Gjør dette ved å «mappe» funksjonen coeff() på list_column modell.

```{r}
NUTS2_diff <- NUTS2_diff |>
  group_by(nc_name, n2) |>
  mutate(
    mod_coeff <- bind_rows(map(
    .x = modell,
    .f = coef
    )
    )
    )
```

## Oppgave 36
Bruker glance() funksjonen fra broom pakken og «map» denne på modell variabelen for å generere «model summary». Legg resultatet i en variabel mod_sum.

```{r}
NUTS2_diff <- NUTS2_diff  |> 
  group_by(nc_name, n2) |> 
  mutate(
    mod_sum = bind_rows(
      map(
        .x = modell,
        .f = glance
        )
    )
    )
```

## Oppgave 37
Hvilken NUTS1 sone har høyest for vår modell og hvilken sone har lavest?

```{r}
#| paged.print: false
NUTS2_diff |>
  arrange(desc(mod_sum$r.squared)) |>
  head(n = 3)

NUTS2_diff |>
  arrange(mod_sum$r.squared) |>
  head(n = 3)
```

## Oppgave 38
Hvilken NUTS1 sone har høyest koeffisient for diff_gdp_per_capita?
```{r}
#| paged.print: false
NUTS2_diff |>
  arrange(desc(diff_gdp_per_capita)) |>
  head(n = 3)
```
  

NUTS2-regionen med høyest koeffisient: AL02 i Albania.

#### Oppgave 39

Hvor mange av de 256 (218) koeffisientene er signifikante på 5% nivå?

```{r}
# Hent ut koeffisient-estimat og p-verdi fra alle modellene
coef_tidy <- NUTS2_diff2 |>
  select(nc_name, n2, modell) |>
  mutate(
    tidy_coef = map(modell, tidy)
  ) |>
  unnest(tidy_coef) |>
  filter(term == "diff_gdp_per_capita") |>
  filter(is.finite(p.value))
```

```{r}
coef_tidy |>
  summarise(
    totalt_antall = n(),
    signifikante_5pct = sum(p.value < 0.05),
    andel_signifikante = mean(p.value < 0.05)
  )
```

Ut fra tibbelen får vi et antall på 162 av de totale 218 som er statistisk signifikante på 5 % nivå. Dette betyr at disse regionene har en sammenheng mellom endringer i BNP per innbygger og endringer i regional ulikheter som kan måles med data.


#### Oppgave 40

Bruk ggplot til å lage et «density plot» av variabelen diff_gdp_per_capita.
Legg inn en vertikal linje for gjennomsnitt diff_gdp_per_capita.
(Hint! Husk argumentet na.rm = TRUE.).
Resultatet skal bli som i plottet under.

```{r}
coef_tidy |>
  ggplot(aes(x = estimate)) +
  geom_density(na.rm = TRUE) +
  geom_vline(
    xintercept = mean(coef_tidy$estimate, na.rm = TRUE),
    linetype = "dashed"
  ) +
  theme_minimal() +
  labs(
    x = "diff_gdp_per_capita",
    y = "Density",
    title = "Tetthetsplot av diff_gdp_per_capita"
  )
```

#### Oppgave 41

Hvor mange av de 256 (218) regrersjonskoeffisientene for diff_gdp_per_capita er positive?

```{r}
NUTS2_diff |>
  filter(diff_gdp_per_capita > 0) |>
  dim()
```

Svaret visar et flertall av NUTS2-regionene på om lag 61 %, som er sammenhengen mellom endringer i BNP per innbygger og endringer i regional ulikhet positiv.

#### Oppgave 42

```{r}
coef_tidy |>
  summarise(
    mean_coef   = mean(estimate),
    median_coef = median(estimate)
  )
```

#### Oppgave 43

Utfør en enkel t-test for å teste om diff_gdp_per_capita er signifikant større enn 0.
Er diff_gdp_per_capita signifikant større enn 0?

```{r}
t.test(
   NUTS2_diff$mod_coeff$diff_gdp_per_capita,
  alternative = "greater"
)
```

## Panel modell

#### Oppgave 44

Bruk funksjonen plm() fra pakken plm til å utføre en panel-regresjon på dataene.
For argumentet index kan dere bruke index = c("n3", "time").
Bruk samme enkle modell som ovenfor dvs.
diff_gini_nuts2 \~ diff_gdp_per_capita.
Putt resultatet av regresjonen i et objekt p_mod.

```{r}
p_mod <- plm(formula = "diff_gini_nuts2 ~ diff_gdp_per_capita", data = unnest(select(NUTS2_diff, 
    n2, NUTS2_diff), NUTS2_diff), index = c("n3", "time"))
```

#### Oppgave 45

Vis summary() for p_mod og tolk resultatet.

```{r}
summary(p_mod)
```

#### Oppgave 46

En alternativ måte å finne summary() for p_mod er gjengitt i chunk-en nedenfor.
**Forklar hva som blir gjort her og sammenlign med resultatet av en ordinær summary().**

```{r}
summary(
  p_mod,
  vcov = function(x) plm::vcovHC(x, method = "white2")
)
```
Eneste endringen er på F-statistic fra 253.536 til 200.369




