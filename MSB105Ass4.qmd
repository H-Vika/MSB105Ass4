---
title: "Assignment 4:"
subtitle:  "Eu statistikk."
author: "Magnus Eidesmo og Harald Vika"
date: last-modified
date-format: "dddd D MMM, YYYY"
lang: en-GB
format:
  html: default
  typst:
    papersize: a4
  pdf: 
    documentclass: article
    number-sections: true
    keep-tex: true
    papersize: A4
    fig-pos: "H"
abstract: ""
editor: 
  markdown: 
    wrap: sentence
echo: false
---

```{r}
#| label: setup
#| message: false
#| warning: false
library(tidyverse)
library(readxl)
library(restatapi)
library(DescTools)
library(ggrepel)
library(flextable)
library(modelr)
library(plm)
library(broom)
library(sandwich)
```

```{r}
# Henter innholdsfortegnelse fra Eurostat

toc_txt <- get_eurostat_toc(mode = "txt")
```

```{r}
# Vi finner tabellbeskrivelser som både inneholder gdp og nuts 3
gdp_tabs <- toc_txt |>
 filter(
 str_detect(
 string = title,
 pattern = '[Gg][Dd][Pp]'
 ) &
 str_detect(
 string = title,
 pattern = '[Nn][Uu][Tt][Ss]\\s*3'
 )
 ) |>
 select(title, code)

gdp_tabs |>
 select(title, code) |>
 flextable() |>
 width(1, width = 3.5) |>
 width(2, width = 1.5)

```


```{r}
# description nama_10r_3gdp
dsd_gdp <- get_eurostat_dsd("nama_10r_3gdp")

```

```{r}
#| tbl-cap: "Frekvensen er årlig og vi velger å benytte MIO_PPS_EU27_2020 som enhet."
dsd_gdp |>
 filter(concept %in% c('freq', 'unit')) |>
 flextable() |>
 width(j = 1, width = 1) |>
 width(j = 2, width = 2) |>
 width(j = 3, width = 2)

```
```{r}
#| tbl-cap: "Eksempel for geo-variabelen. Vi ser at vi har nivåene fra NUTS3 (BE213; Arr. Turnhout) via nivå NUTS2 (BE21; Prov. Antwerpen) via nivå NUTS1 (BE2; Vlaams Gewest) til landsnivå (BE; Belgium)."

dsd_gdp |>
 filter(concept %in% c('geo')) |>
 head(n = 10) |>
 flextable() |>
 width(j = 1, width = 1) |>
 width(j = 2, width = 2) |>
 width(j = 3, width = 2)

```

```{r}
#| eval: true
#| cache: true
# Gross domestic product (GDP) at current market prices by NUTS 3 regions
# id: nama_10r_3gdp
# Vi velger å hente samtlige soner for så å filtrere ut de få vi ikke trenger

gdp <- get_eurostat_data(
 id = "nama_10r_3gdp",
 filters = list(
 # neste linje viser hvordan vi kunne ha hentet ut data for spesifiserte land
 # geo = c("AT", "DE", "DK", "FR"),
 nuts_level = "3",
 unit = "MIO_PPS_EU27_2020"
 ),
 exact_match = FALSE,
 date_filter = 2000:2023,
 stringsAsFactors = FALSE
 ) |>
 mutate(
 gdp_n3 = 1000000 * values
 ) |>
 select(-c(unit, values)) |>
 # Vil bare ha NUTS 3 nivå (5 karakterer). Vil aggregere selv til NUTS2, NUTS1 og NUTSc
 filter(str_length(geo) == 5) |>
 as_tibble()

```

```{r}
# Kontroll
dim(gdp)
gdp
```

```{r}
# Mangler data for årene 2015, 2016 og 2017.

gdp |>
 filter(geo == "IE053") |>
 print(n = 25)
```

```{r}
# Vi legger derfor disse til gdp som NA verdier. Disse vil vi så erstatte med interpolerte verdier senere.

ie_data <- tibble(
 geo = c("IE053", "IE053", "IE053"),
 time = c("2015", "2016", "2017"),
 gdp_n3 = c(NA, NA, NA)
)

```

```{r}
# Slår sammen dataene
gdp <- rbind(gdp, ie_data)
```

```{r}
# Lager interpolerte verdier til NA verdidene
gdp <- gdp |>
 arrange(geo, time) |>
 mutate(
 gdp_n3 = zoo::na.approx(gdp_n3)
 )
```

```{r}
gdp |>
 filter(geo == "IE053") |>
 print(n = 25)

```

# Population demo_r_pjanaggr3

#### Oppgave 1
Søk i toc_txt for tabeller med population og NUTS 3. Pass på at dere dekker både population
og Population og ulike skrivemåter for NUTS 3.

```{r}
pop_tabs <- toc_txt |>
  filter(
    str_detect(
      string = title,
      pattern = "[Pp]opulation"
    ) &
    str_detect(
      string = title,
      pattern = "[Nn][Uu][Tt][Ss]\\s*3"
    )
  ) |>
  select(title, code)

pop_tabs |>
  flextable() |>
  width(1, width = 4) |>
  width(2, width = 2)

```

#### Oppgave 2
i. Finn koden for tabellen med forklarende tekst «Average annual population to calculate regional GDP data (thousand persons) by NUTS 3 regions».

```{r}
pop_tab <- toc_txt |>
  filter(
    str_detect(title, "Average annual population") &
      str_detect(title, "[Nn][Uu][Tt][Ss]\\s*3")
  ) |>
  select(title, code)

pop_tab
```

ii. Last ned Data Structure Definition (DSD) for denne tabellen.

```{r}
pop_code <- pop_tab$code[1]

dsd_pop <- get_eurostat_dsd(pop_code)


dsd_pop |>
 head(n = 10) |>
 flextable() |>
 width(j = 1, width = 1) |>
 width(j = 2, width = 2) |>
 width(j = 3, width = 2)

```

iii. Bruk opplysningene i DSD for å formulere en spørring mot Eurostat og last ned dataene. Gi dataene lastet ned navnet pop. Vi er bare interessert i totalbefolkning og ignorerer derfor både kjønn og alder. Vi ønsker data for årene 2000-2023.

```{r}
#| eval: true
#| cache: true
pop_raw <- get_eurostat_data(
  id = pop_code,
  filters = list(
    nuts_level = "3"
  ),
  exact_match = FALSE,
  date_filter = 2000:2023,
  stringsAsFactors = FALSE
)

pop <- pop_raw |>
  mutate(
    pop_n3 = 1000 * values) |>
  select(geo, time, pop_n3) |>
  filter(str_length(geo) == 5) |>
  as_tibble()
```

```{r}
dim(pop)
pop
```

#### Oppgave 3

Gjør en left_join() av de to tabellene. La gdp være venstre tabell (Viktig!). Gi resultatet
navnet gdp_pop.

```{r}
gdp_pop <- gdp |>
  left_join(pop, by = join_by(geo, time))

```

```{r}
eu_data <- gdp_pop %>%
 # Trenger ikke ZZ sonene som er en slag oppsamlingssone
 # for ikke fordelte verdier
 filter(!str_sub(geo, 3, 4) == "ZZ") |>
 # Drop the EFTA countries Switzerland and Norway
 filter(!str_sub(geo, 1, 2) %in% c("CH", "NO")) |>
 # Drop the EU countries Netherlands and Portugal
 filter(!str_sub(geo, 1, 2) %in% c("NL", "PT")) |>
 # Drop candidate country Monte Negro because of data
 filter(!str_sub(geo, 1, 2) %in% c("ME")) |>
 # Drop a region of France in the Indian Ocean (Outre Mer); Mayotte
 # because of missing data
 filter(!geo == "FRY50") |>
 # note that a few countries will have missing data for
 # some years at the start of the period
 filter(time > 1999 & time < 2023)

```

```{r}
eu_data <- eu_data |>
  mutate(gdp_pc_n3 = gdp_n3 / pop_n3)

```

```{r}
# Kontroll
dim(eu_data)
```

```{r}
# sjekker om vi mangler noen data
dim(
  eu_data |>
    filter(is.na(gdp_pc_n3))
)
```
Var ikke noe mer NA-verdier igjen i gdp_pc_n3
Kvitter oss med andre objekter for å rydde litt ettersom vi bare skal bruke eu_data videre:
```{r}

# don't run if you don't mean it.
rm(list = setdiff(ls(), c("eu_data")))
```

#### Oppgave 4
Endre navnet på variabelen geo til n3 og lag variablene n2 (NUTS2), n1 (NUTS1) og nc (for
«Country») fra variabelen n3. Funksjonen str_sub() fra stringr pakken kan her være
hendig å bruke.

```{r}
eu_data <- eu_data |>
  rename(n3 = geo) |>
  mutate(
    n2 = str_sub(n3, 1, 4),
    n1 = str_sub(n3, 1, 3),
    nc = str_sub(n3, 1, 2)
  )

```


#### Oppgave 5
Undersøk om vi har noen NUTS 3 soner med pop_n3 lik 0. Hvis det er noen så endre disse
til NA.

Undersøker: 
```{r}
eu_data |>
  filter(pop_n3 == 0)
```
Fant ingen rader med 0 og vi går videre, trenger ikke å endre noe til NA.


#### Oppgave 6
Sjekk hvor mange NUTS3 soner vi har i hvert land.

```{r}
eu_data |>
  select(nc, n3) |> 
  distinct() |> 
  group_by(nc) |> 
  summarise(
    num_nuts3 = n(),
    .groups = "drop"
  ) |>
  arrange(desc(num_nuts3)) 

```

#### Oppgave 7
Sjekk summary gdp_pc_n3. Hva er største og minste verdi? Har vi noen NA?

```{r}
summary(eu_data$gdp_pc_n3)
```

#### Oppgave 8
Bruk case_when() for å legge til variabelen nc_name før vi går videre. Østerrike for AT,
Belgia for BE etc..

```{r}
eu_data <- eu_data |>
  mutate(
    nc_name = case_when(
      nc == "AL" ~ "Albania",
      nc == "AT" ~ "Østerrike",
      nc == "BE" ~ "Belgia",
      nc == "BG" ~ "Bulgaria",
      nc == "CY" ~ "Kypros",
      nc == "CZ" ~ "Tjekkia",
      nc == "DE" ~ "Tyskland",
      nc == "DK" ~ "Danmark",
      nc == "EE" ~ "Estland",
      nc == "EL" ~ "Hellas",
      nc == "ES" ~ "Spania",
      nc == "FI" ~ "Finland",
      nc == "FR" ~ "Frankrike",
      nc == "HR" ~ "Kroatia",
      nc == "HU" ~ "Ungarn",
      nc == "IE" ~ "Irland",
      nc == "IT" ~ "Italia",
      nc == "LT" ~ "Litauen",
      nc == "LU" ~ "Luxemburg",
      nc == "LV" ~ "Latvia",
      nc == "MK" ~ "Nord-Makedonia",
      nc == "MT" ~ "Malta",
      nc == "PL" ~ "Polen",
      nc == "RO" ~ "Romania",
      nc == "RS" ~ "Serbia",
      nc == "SE" ~ "Sverige",
      nc == "SI" ~ "Slovenia",
      nc == "SK" ~ "Slovakia",
      nc == "TR" ~ "Tyrkia",
      TRUE ~ NA_character_
    )
  )

```


```{r}
# Kontroll

eu_data |>
 select(nc_name, nc) |>
 distinct() |>
 print(n = 30)

```


## Beregning av Gini på NUTS2, NUTS1 og NUTSc nivå

#### Oppgave 9
Bruk koden nedenfor til å beregne Gini-koeffisienter på NUTS2 nivå. Finn også antall NUTS3 regioner som finnes i hver NUTS2 region. Gi denne variabelen navnet num_reg_n2.
Vi beregner også populasjon og gdp på NUTS2 nivå. Resultatet legger dere i en tibble kalt
gini_n2.

```{r}
gini_n2 <- eu_data |>
 group_by(n2, time, n1, nc, nc_name) |>
 summarise(
 gini_n2 = DescTools::Gini(gdp_pc_n3, weights = pop_n3, na.rm = TRUE),
 pop_n2 = sum(pop_n3),
 gdp_n2 = sum(gdp_n3),
 gdp_pc_n2 = gdp_n2 / pop_n2,
 num_reg_n2 = n(),
 .groups = "drop"
 )

gini_n2 |>
  select(gini_n2, num_reg_n2, pop_n2, gdp_n2, gdp_pc_n2) |>
  summary() |>
  print(width = 80)

```
#### Oppgave 10
Sjekk obs. med Gini mindre enn 0.001. Er det noe som kjennetegner disse regionene?

```{r}
low_gini_n2 <- gini_n2 |>
  filter(gini_n2 < 0.001) |>
  arrange(gini_n2)

low_gini_n2 |>
  select(nc_name, n2, time, gini_n2, num_reg_n2) |>
  print(n = 50)

```
Alle disse regionene har kun to underliggende NUTS3 regioner. Og i disse årene er de underliggende NUTS3 regionene tilnærmet like, derfor får vi en såpass lav gini.


#### Oppgave 11
Beregn Gini-koeffisienter på NUTS1 nivå (ut fra gdp_pc_n3og pop_n3). Legg resultatet i
gini_n1. Et alternativ her ville vært å beregnet Gini fra gdp_pc_n2 og pop_n2 i NUTS1
regionene. Vi får imidlertid større spredning og trolig også et bedre mål på likhet/ulikhet
ved å beregne Gini utfra gdp_pc_n3og pop_n3.

```{r}
gini_n1 <- eu_data |>
  group_by(n1, time, nc, nc_name) |>
  summarise(
    gini_n1 = DescTools::Gini(
      gdp_pc_n3,
      weights = pop_n3,
      na.rm = TRUE
    ),
    pop_n1 = sum(pop_n3, na.rm = TRUE),
    gdp_n1 = sum(gdp_n3, na.rm = TRUE),
    gdp_pc_n1 = gdp_n1 / pop_n1,
    num_reg_n1 = n(),
    .groups = "drop"
  )

gini_n1 |>
  select(gini_n1, num_reg_n1, gdp_n1, pop_n1, gdp_pc_n1) |>
  summary() |>
  print(width = 80)
```

#### Oppgave 12
Beregn Gini-koeffisienter (ut fra variasjon i verdiskapning på NUTS3 nivå) på nasjonsnivå. Legg resultatet i gini_nc.

```{r}
gini_nc <- eu_data |>
  group_by(nc, nc_name, time) |>
  summarise(
    gini_nc = DescTools::Gini(
      gdp_pc_n3,
      weights = pop_n3,
      na.rm = TRUE
    ),
    pop_nc = sum(pop_n3, na.rm = TRUE),
    gdp_nc = sum(gdp_n3, na.rm = TRUE),
    gdp_pc_nc = gdp_nc / pop_nc,
    num_reg_nc = n(),
    .groups = "drop"
  )

gini_nc |>
  select(gini_nc, num_reg_nc, gdp_nc, pop_nc, gdp_pc_nc) |>
  summary() |>
  print(width = 80)
```

## «Nestete» datastrukturer

#### Oppgave 13
Bruk koden nedenfor til å «neste» dataene på NUTS3 nivå.

```{r}
gini_n3_nest <- eu_data |>
  group_by(nc_name, nc) |>
  nest(.key = "NUTS3_data") |>
  ungroup()
```

```{r}
gini_n3_nest
```


#### Oppgave 14
Nest dataene på NUTS2 nivå. Legg resultatet gini_NUTS2_nest. Bruk .key = "NUTS2_data".

```{r}
gini_NUTS2_nest <- gini_n2 |>
  group_by(nc_name, nc) |>
  nest(.key = "NUTS2_data") |>
  ungroup()

```

```{r}
gini_NUTS2_nest
```

#### Oppgave 15
«Nest» dataene på NUTS1 nivå. Legg resultatet gini_NUTS1_nest.

```{r}
gini_NUTS1_nest <- gini_n1 |>
  group_by(nc_name, nc) |>
  nest(.key = "NUTS1_data") |>
  ungroup()
```

```{r}
gini_NUTS1_nest
```

#### Oppgave 16
«Nest» dataene på nasjonsnivå. Legg resultatet i gini_NUTSc_nest.

```{r}
gini_NUTSc_nest <- gini_nc |>
  group_by(nc_name, nc) |>
  nest(.key = "NUTSc_data") |>
  ungroup()
```

```{r}
gini_NUTSc_nest
```

#### Oppgave 17
«Nest» dataene på EU nivå, dvs. Gini for samtlige NUTS3 regioner hvert år. Legg resultatet
i gini_NUTSeu_nest. _nest er her litt misvisende siden vi ikke gjør noen nesting

```{r}
gini_NUTSeu_nest <- eu_data |>
 group_by(time) |>
 summarise(
 gini_eu = DescTools::Gini(gdp_pc_n3, weights = pop_n3, na.rm = TRUE),
 num_reg_eu = n(),
 .groups = "drop"
 )
```

#### Oppgave 18
Vis utviklingen i Gini-koeffisienten for NUTS3 regioner i EU vha. et linjeplot.

```{r}
gini_NUTSeu_nest |>
  ggplot(aes(x = as.integer(time), y = gini_eu)) +
  geom_line(linewidth = 1) +
  geom_point(size = 1) +
  labs(
    title = "Utviklingen i Gini-koeffisienten for NUTS3-regioner i EU",
    x = "Year",
    y = "gini_eu"
  ) +
  theme_minimal()

```

#### Oppgave 19
Basert på plottet fra foregående oppgave diskuter (veldig!) kort om tiltaket ser ut til å virke.

Plottet viser en tydelig fallende trend i Gini-koeffisienten for NUTS3-regioner i EU over perioden, særlig fra midten av 2000-tallet og fremover. Dette indikerer at ulikheten i verdiskaping mellom regioner har blitt redusert over tid. Utviklingen er konsistent med målsettingen bak EUs strukturfond og samholdsfond, som retter investeringer mot mindre utviklede regioner. Selv om andre faktorer også kan ha påvirket utviklingen, gir plottet støtte til at tiltakene samlet sett kan ha hatt en utjevnende effekt på regional ulikhet i EU.

#### Oppgave 20
Ta gini_n3_nestsom utgangspunkt og bruk left_join() til å legge til datasettene gini_NUTS2_nest, gini_NUTS1_nest og gini_NUTSc_nest

```{r}
eu_data_nested <- gini_n3_nest |>
  left_join(gini_NUTS2_nest, by = c("nc_name", "nc")) |>
  left_join(gini_NUTS1_nest, by = c("nc_name", "nc")) |>
  left_join(gini_NUTSc_nest, by = c("nc_name", "nc"))

```

```{r}
# don't run if you don't mean it.
rm(list = setdiff(ls(), c("eu_data", "eu_data_nested")))
```

## Plots som viser utviklingen

#### Oppgave 21




































